<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>

  <!-- Link to Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- Favicon Links -->
  <link rel="icon" type="image/png" href="/favicon/favicon-96x96.ico" sizes="96x96" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.ico" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" />

  <style>
    /* Styling (same as before) */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #222222;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      color: #ffffff;
    }

    .navbar-container {
      width: 100%;
      display: flex;
      justify-content: center;
      background-color: #222222;
      margin-bottom: 20px;
    }

    .navbar-navbar-interactive {
      width: 100%;
      max-width: 1200px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }

    .navbar-links1 {
      display: flex;
      gap: 20px;
    }

    .navbar-links1 a {
      color: #ffffff;
      font-size: 16px;
      text-decoration: none;
      padding: 10px;
      transition: 0.3s ease;
    }

    .navbar-links1 a:hover {
      color: #25c3e2;
    }

    .navbar-auth-buttons a {
      padding: 10px 20px;
      color: #ffffff;
      border: 1px solid #25c3e2;
      border-radius: 4px;
      text-decoration: none;
      font-size: 16px;
      transition: 0.3s ease;
    }

    .navbar-auth-buttons a:hover {
      background-color: #25c3e2;
      color: #222222;
    }

    .dashboard-container {
      width: 100%;
      max-width: 1200px;
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 40px;
      align-items: flex-start;
    }

    .welcome-back {
      font-size: 28px;
      color: #ffffff;
      margin-bottom: 20px;
    }

.dashboard-boxes {
  width: 100%;
  display: flex;
  gap: 20px;
}

.left-boxes {
  width: 50%; /* Adjusted to 50% width */
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.right-boxes {
  display: flex;
  flex-direction: column;
  gap: 20px;
  flex-grow: 1;  /* This allows it to take up the remaining space */
}

.right-box {
  display: flex;
  flex-direction: column;
  justify-content: flex-start; /* Ensures content stays at the top */
  min-height: 240px;  /* Adjust this to your preferred box height */
  padding: 30px;
  background-color: #333333;
  border-radius: 8px;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
}

.right-box:last-child {
  min-height: 270px;  /* Make the bottom box longer (adjust as needed) */
}

.left-box {
  background-color: #333333;
  padding: 30px;
  border-radius: 8px;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
}


    .left-box h1, .right-box h1 {
      font-size: 30px;
      color: #ffffff;
      margin-bottom: 20px;
    }

    .left-box p, .right-box p {
      font-size: 16px;
      margin: 10px 0;
    }

    .left-box .button, .right-box .button {
      width: 100%;
      padding: 15px;
      background-color: #25c3e2;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
      transition: 0.3s ease;
    }

    .left-box .button:hover, .right-box .button:hover {
      background-color: #1a9ca9;
    }

    .switch-battalion {
      color: #25c3e2;
      text-decoration: none;
      font-size: 16px;
      transition: 0.3s ease;
    }

    .switch-battalion:hover {
      text-decoration: underline;
    }

    /* Leaderboard Styles */
    .leaderboard-box {
      width: 100%;
      padding: 30px;
      background-color: #333333;
      border-radius: 8px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
    }

    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
    }

    .leaderboard-table th, .leaderboard-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #444444;
    }

    .leaderboard-table th {
      color: #ffffff;
      background-color: #444444;
    }

    .leaderboard-table tr:hover {
      background-color: #555555;
    }

    @media(max-width: 767px) {
      .dashboard-container {
        padding: 20px;
      }

      .dashboard-boxes {
        flex-direction: column;
        gap: 20px;
      }

      .left-boxes, .right-box {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="navbar-container">
    <div class="navbar-navbar-interactive">
      <nav class="navbar-desktop-menu">
        <div class="navbar-links1">
          <a href="https://www.hope-of-israel.com">Home</a>
          <a href="https://www.hope-of-israel.com/contact">Contact</a>
          <a href="https://www.hope-of-israel.com/about">About</a>
          <a href="https://www.familysearch.org/temple/ordinances-ready" target="_blank">Find Names</a>
        </div>
      </nav>
    </div>
  </div>

  <div class="dashboard-container">
    <div class="welcome-back">
      Welcome back, <span id="user-name">Loading...</span>!
    </div>

    <div class="dashboard-boxes">
      <div class="left-boxes">
        <div class="left-box">
          <h1>Your Dashboard:</h1>
          <p id="user-total-names">Total names completed: Loading...</p>
          <p>Have more to add? Update Total</p>
          <a href="add-names.html">
            <button class="button" id="update-total-btn">Update Total</button>
          </a>
        </div>

        <div class="left-box">
          <h1>Goals:</h1>
          <p id="user-weekly-goal">Weekly Goal: Loading...</p>
          <p id="user-monthly-goal">Monthly Goal: Loading...</p>
          <p id="user-yearly-goal">Yearly Goal: Loading...</p>
          <a href="goal.html">
            <button class="button" id="update-goal-btn">Update Goal</button>
          </a>
        </div>

        <div class="left-box">
          <h1>Temple:</h1>
          <p>Ready to attend the temple?</p>
          <a href="https://www.familysearch.org/temple/ordinances-ready" target="_blank">
            <button class="button">Find Family Names</button>
          </a>
          <a href="https://www.churchofjesuschrist.org/temples/schedule/appointment" target="_blank">
            <button class="button">Schedule Appointment</button>
          </a>
        </div>
      </div>

      <div class="right-boxes">
        <div class="right-box">
          <h1>Battalion: <span id="user-battalion">Loading...</span></h1>
          <p id="battalion-total-names">Total Names Completed: Loading...</p>
        </div>

        <div class="right-box">
          <h1>Global</h1>
          <p id="global-total-names">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Leaderboard Box -->
    <div class="leaderboard-box">
      <h1>Leaderboard</h1>
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Battalion</th>
            <th>Total Names Completed</th>
          </tr>
        </thead>
        <tbody id="leaderboard-table-body">
          <!-- Leaderboard data will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
    import { firebaseConfig } from "./firebase/firebaseConfig.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const firestore = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const userRef = doc(firestore, "users", user.uid);
        getDoc(userRef).then((docSnapshot) => {
          if (docSnapshot.exists()) {
            const userData = docSnapshot.data();
            document.getElementById("user-name").textContent = userData.name;
            document.getElementById("user-total-names").textContent = `Total names completed: ${userData.completedNames || 0}`;
            document.getElementById("user-weekly-goal").textContent = `Weekly Goal: ${userData.weeklyGoal || 'Not Set'}`;
            document.getElementById("user-monthly-goal").textContent = `Monthly Goal: ${userData.monthlyGoal || 'Not Set'}`;
            document.getElementById("user-yearly-goal").textContent = `Yearly Goal: ${userData.yearlyGoal || 'Not Set'}`;
            document.getElementById("user-battalion").textContent = userData.battalion;

            // Fetch battalion and global totals
            let battalionNames = 0;
            let globalTotalNames = 0;
            const battalionData = {};

            // Get all users data and compute totals
            getDocs(collection(firestore, "users")).then((querySnapshot) => {
              querySnapshot.forEach((doc) => {
                const userData = doc.data();
                globalTotalNames += userData.completedNames || 0;

                // Group by battalion
                if (!battalionData[userData.battalion]) {
                  battalionData[userData.battalion] = 0;
                }
                battalionData[userData.battalion] += userData.completedNames || 0;
              });

              // Update the user battalion total
              document.getElementById("battalion-total-names").textContent = `Total Names Completed: ${battalionData[userData.battalion] || 0}`;
              document.getElementById("global-total-names").textContent = `Global Names Completed: ${globalTotalNames}`;

              // Update leaderboard
              const sortedBattalions = Object.entries(battalionData).sort((a, b) => b[1] - a[1]);
              const leaderboardTableBody = document.getElementById("leaderboard-table-body");

              sortedBattalions.forEach(([battalion, totalNames], index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${index + 1}</td>
                  <td>${battalion}</td>
                  <td>${totalNames}</td>
                `;
                leaderboardTableBody.appendChild(row);

// Fetch battalion and global totals
let battalionNames = 0;
let globalTotalNames = 0;
const battalionData = {};

// Get all users data and compute totals
getDocs(collection(firestore, "users")).then((querySnapshot) => {
  querySnapshot.forEach((doc) => {
    const userData = doc.data();
    globalTotalNames += userData.completedNames || 0;

    // Group by battalion
    if (!battalionData[userData.battalion]) {
      battalionData[userData.battalion] = 0;
    }
    battalionData[userData.battalion] += userData.completedNames || 0;
  });

  // Update the global total names
  document.getElementById("global-total-names").textContent = `Global Names Completed: ${globalTotalNames}`;

  // Update the user battalion total (For now showing the first battalion)
  // If you need to display a specific battalion's total, use the correct battalion here
  const firstBattalion = Object.keys(battalionData)[0];
  document.getElementById("battalion-total-names").textContent = `Total Names Completed: ${battalionData[firstBattalion] || 0}`;

  // Update leaderboard
  const sortedBattalions = Object.entries(battalionData).sort((a, b) => b[1] - a[1]);
  const leaderboardTableBody = document.getElementById("leaderboard-table-body");

  // Clear any previous leaderboard data
  leaderboardTableBody.innerHTML = '';

  sortedBattalions.forEach(([battalion, totalNames], index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${battalion}</td>
      <td>${totalNames}</td>
    `;
    leaderboardTableBody.appendChild(row);
  });
});

// Install prompt logic
let deferredPrompt;
const installButton = document.createElement("button");
installButton.textContent = "Install App";
installButton.style.cssText = `
  position: fixed;
  bottom: 20px;
  right: 20px;
  background-color: #25c3e2;
  color: #ffffff;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  display: none; /* Initially hide the button */
`;

document.body.appendChild(installButton);

window.addEventListener("beforeinstallprompt", (e) => {
  // Prevent the mini-infobar from appearing
  e.preventDefault();
  // Save the event so it can be triggered later
  deferredPrompt = e;

  // Show the install button
  installButton.style.display = "block";

  installButton.addEventListener("click", () => {
    // Hide the button
    installButton.style.display = "none";
    // Show the install prompt
    deferredPrompt.prompt();
    // Wait for the user to respond to the prompt
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === "accepted") {
        console.log("User accepted the A2HS prompt");
      } else {
        console.log("User dismissed the A2HS prompt");
      }
      // Reset the deferred prompt variable
      deferredPrompt = null;
    });
  });
});

// Optional: Hide the install button after the app is installed
window.addEventListener("appinstalled", () => {
  console.log("App was installed");
  installButton.style.display = "none";
});


              });
            });
          }
        });
      }
    });
  </script>
</body>
</html>
